\section{Granting Authorization}
\label{sec:authorization_grant}
In this section, we present a protocol for authorization grants using SSTP. One of the goals of SSTP is to provide first-class support for the ability
for a principal (the user) to grant a third-party client permission to perform some action on a
target server. 
Existing protocols such as SSH do not natively support such use cases, and workarounds such as ssh-agent
forwarding are insecure~\cite{kogan2017guardian-agent}.
We abide by the Secure Delegation Principle defined by Kogan et al.~\cite{kogan2017guardian-agent}, which allows a client to act under a principal's authority only after the principal can verify
and enforce the client's intent. This intent includes the identity of the client used for the
authorization grant, a single command the client can issue, and to whom the client
can issue the command. 




Broadly speaking, the process works as follows. We assume that the client has already been
authenticated to the principal and shares an SSTP connection with it. The client requests that the principal grants permission for it to perform an
action on the server, i.e., the \emph{intent}. If the principal approves the intent
request, it establishes an SSTP tunnel with the server, proxied through the client. The principal
communicates the identity and intent of the client to the server over the newly created SSTP tunnel.
If the server also approves the intent, the client can then establish its own SSTP tunnel with the
server using the identity approved by the principal and execute the specified action. The server
enforces that any action executed by the client (using the current identity) is performed at most
once.

This differs from GuardianAgent in that there is no session ``hand-off''.



\subsection{Authorization Grant Channel}
Authorization Grant Channels are reliable SSTP channels used to run
the authorization grant protocol. 
Each channel message is of the form \texttt{Type $||$ Data}, where the single byte \texttt{Type}
field is one of: \texttt{INTENT\_REQUEST},
\texttt{INTENT\_COMMUNICATION}, \texttt{INTENT\_CONFIRMATION}, or \texttt{INTENT\_DENIED}. For
Intent Requests and Intent Communications, the \texttt{Data} field is the \emph{Intent} (Figure~\ref{fig:intent}), which contains a hash of an ephemeral public key the client will
use as its ``temporary'' client static in the authorization grant, the name and port of the server it wishes to connect to, a single channel type, and any associated data for the channel
(e.g., a command to be run). The \texttt{Data} field in Intent Confirmation messages contain a
timestamp deadline set by the server for the client to complete the SSTP handshake.
Intent Denied messages will indicate the reason the authorization grant was denied.


\input{bytefields/intent.tex}

\subsection{Network Proxy Channel}
In many cases, the principal may not necessarily have direct connectivity to the server. Therefore,
in order to establish an SSTP tunnel between the principal and the server, the client proxies the connection. We can do this using a reliable SSTP Network Proxy Channel between the
principal and the client. To initiate a Network Proxy Channel, the principal sends a Channel
Initiation Request with the Network Proxy channel type and the server's name and port (specified in
the Intent) as the initial data. Once the channel has been established, the client decapsulates all
data frames sent through the channel and forwards them to the server, and likewise collects
responses and forwards them back to the principal through the channel. 

\subsection{Authorization Grant Protocol}

\begin{figure}
    \includegraphics[width=1\columnwidth]{figures/authorization_grant.pdf}
    \vspace{-5pt}
    \caption{\textbf{Authorization Grant Protocol}---%
    \textnormal{}
    }
    \label{fig:authorization_grant}
\end{figure}

\subsubsection{Intent Request}
The client first makes an Intent Request for the principal to approve or deny. To do so, 
it initiates a reliable Authorization Grant Channel with the principal, and sends an Intent Request
over this channel. The principal checks the Intent against its security policy and either
approves or denies the request. If it denies the request, it will reply with an Intent Denied
message indicating the reason it was denied. The client can then choose to either tear down the
Authorization Grant Channel or attempt a new Intent Request.

\subsubsection{Intent Communication}
Once the principal approves the Intent Request, it communicates the Intent to the server by
initiating a reliable Network Proxy channel with the client.
% Because the principal may not necessarily have direct connectivity to the server, it initiates a
% reliable
% Network Proxy channel with the client and has the client proxy a connection to the server. The client forwards
% any messages sent through the Network Proxy channel to the server over UDP, and any replies
% from the server are forwarded back to the principal through the Network Proxy channel. 
Through this channel, the principal establishes an SSTP
tunnel with the server and initiates a new reliable Authorization Grant Channel. It then relays the Intent to
the server via an Intent Communication message. At this
point, the server has a hash of the client's identity, the action it wishes to execute, and who is
granting them authorization. If the server accepts the Intent, it sets a deadline for the client to
complete an SSTP handshake and sends the principal an Intent
Confirmation message. Otherwise, it sends an Intent Denied message with a reason. Note that
the communication between the principal and the server is end-to-end by virtue of SSTP, so any
Intent Communication messages cannot be read nor tampered with by the client. 

\subsubsection{Intent Confirmation}
The principal forwards the response from the server (either the Intent Confirmation or the Intent
Denied) to the client via the Authorization Grant Channel from before. If the client receives the
Intent Confirmation, it has until the deadline indicated in the Intent Confirmation message to
establish its own SSTP tunnel with the server using its newly authorized credentials. At this point,
the principal tears down any Authorization Grant and Network Proxy channels created as
part of the authorization grant, and ends the SSTP session with the server. If the client receives
an Intent Denied, it can choose to either tear down all channels created as part of the
authorization grant or attempt a new Intent Request with the principal. 

\subsubsection{Completed Authorization Grant}
After the Intent Confirmation, the client establishes an SSTP tunnel with the server using the ephemeral public key specified in the Intent Request as its client
static. At the Client Authentication step of the SSTP handshake (recall from Section~\ref{sec:client_auth}), the
server first checks if the supplied client static is in the list of authorized keys. Since the
client is using the ephemeral key specified in the Intent, this check will fail. The server then
hashes the supplied key and checks to see if the hashed key is among any outstanding authorization
grants on the server. If so, the server continues with the handshake. The deadline
specified in the Intent Confirmation is used to limit the number of outstanding authorization grants
on the server. If the client is unable to complete the SSTP handshake before the deadline expires,
the server drops the authorization grant and the client will have to re-request with the Principal. \todo{should
we define this deadline or let it be set by the server?} Once the action is complete, the server
ends the SSTP connection with the client. The
protocol connection flow is shown in Figure~\ref{fig:authorization_grant}.