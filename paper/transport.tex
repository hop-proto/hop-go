\section{Transport Protocol}




\subsection{Channel Multiplexing}

SSTP supports multiple channels within a single encrypted session. It borrows
and simplifies aspects of QUIC streams to implement a reliable stream
abstraction, but also provides unreliable data delivery within a channel.

An SSTP message is composed of a SessionID, a Counter, Encrypted Data, and MAC.
We encapsulate channel \emph{frames} within the Encrypted Data section of the
SSTP message, providing authentication and encryption by default for all
packets (Figure~\ref{fig:channel_encapsulation}). For simplicitly, only one frame is contained in an SSTP message,
although future extensions may allow multiple frames.

\begin{figure}[h]
	\centering
	\includegraphics[width=0.9\columnwidth]{figures/channel_encapsulation.pdf}
	\caption{\textbf{Channel Encapsulation}---%
	\textnormal{}
	}
	\label{fig:channel_encapsulation}
	\vspace{-5pt}
\end{figure}

All SSTP channel frames are one of four types: 
\begin{itemize}
    \item Channel Initiation Request Frame
    \item Channel Initiation Response Frame
    \item Data Frame
    \item Control Frame
\end{itemize}
Once an encrypted SSTP session has been established, either the client or the
server can request to initiate a shared channel. A channel
handshake is performed to establish the channel and mode (reliable or unreliable). In the absence of the loss
of a handshake message, channel initiation handshakes will complete in a single
round trip. We do not need a TCP-like 3-way handshake
because initial sequence numbers (frame counters) for both direcitons of
communication start at 0. Each channel is identified by a unique channel ID, so
there is no confusion between separate channels, and spoofing attacks from
non-random sequence numbers are already prevented from the encrypted transport
protocol. We show the channel handshake as well as the tear-down sequence in Figure~\ref{fig:channel_protocol}.

% Diagram here
\begin{figure}[h]
	\centering
	\includegraphics[width=0.6\columnwidth]{figures/channel_protocol.pdf}
	\caption{\textbf{Channel initiation handshake and tear-down}---%
	\textnormal{}
	}
	\label{fig:channel_protocol}
	\vspace{-5pt}
\end{figure}

\vspace{5pt} \noindent \textit{Channel Initiation Request:}\quad
The first message from the initiator to the
responder contains a Channel Initiation Request Frame. We show the structure of
the Channel Initiation Request Frame below.

\input{bytefields/initiate_request_frame.tex}

The frame header consists of the Channel ID and the Type. The initiator of the
channel chooses whether the channel mode will be unreliable (0x0) or reliable (0x1).
The maximum frame size the initiator is willing to receive as well as the
initiator's initial window size are established in this first message.
Initiation request frames also denote the
\emph{Action} that will be performed across the channel (e.g., file transfer,
remote shell, network proxy). Action labels will be a value agreed upon by both
the client and the server (or standardized ahead of time), and initial action
data can optionally be sent as well.

\vspace{5pt} \noindent \textit{Channel Initiation Response:}\quad 
After receiving and processing a channel initiation request, the responder replies with a
Channel Initiation Response by echoing the channel ID and either sending a
\texttt{REJECT} (0x0) or \texttt{ACCEPT} (0x1) in the response field. We show
the structure of the Initiation Response Frame below.

\input{bytefields/initiate_response_frame.tex}

If the responder chooses to accept the channel, it also must send a Maximum
Frame Size and Initial Window Size, and echo the Action Label requested by the
initiatior. The responder may also respond with initial action data.

\vspace{5pt} \noindent \textit{Data:}\quad 
After the channel handshake completes, an encrypted channel is established
between the client and server. At this point, either party can begin sending
data packets, in the form of a Channel Data Frame. Again, the frame
header consists of the channel ID for use in channel multiplexing as well as the
frame type (data). For reliable channels, each data frame comes with a Frame
Counter (effectively a sequence number with ISN = 0) and a maximum
acknowledgement delay before retransmission occurs. We discuss loss recovery and
packet reordering in Section~\ref{sec:reliable_channels}. For unreliable channels,
these fields are ignored. The remaining Action Data Size and Action Data contain
the payload. The Data Frame structure is shown below.

\input{bytefields/data_frame.tex}

\vspace{5pt} \noindent \textit{Control:}\quad
SSTP uses control frames primarily for managing loss recovery and reordering for
reliable channels, but also uses control frames with control type \texttt{END}
for either party to indicate that it wishes to end the channel. The encrypted
transport session remains even if all channels end. To end a channel, the
initiator of the channel end request sends a control frame with control type set
to \texttt{END}. The responder can reply with another \texttt{END} frame to
completely end the channel. Once both sides have received and acknowledged
\texttt{END} control frames (similar to TCP connection closing), the channel
ends. We describe other control frame types in Section~\ref{sec:reliable_channels}.The Control Frame structure below. 

\input{bytefields/control_frame.tex}


\subsubsection{Reliable Channels}
Describe loss recovery, monotonically increasing frame counters, retransmission.











